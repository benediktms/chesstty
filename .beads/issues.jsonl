{"id":"chesstty-0wi","title":"Add flat focus model fields and helpers to UiStateMachine","description":"## What\nAdd focused_component: Option\u003cComponent\u003e and expanded: bool fields to UiStateMachine, plus visibility: HashMap\u003cComponent, bool\u003e and scroll: HashMap\u003cComponent, u16\u003e (moved from ComponentManager). Add helper methods: is_board_focused(), selected_component(), expanded_component(), select_component(), expand_component(), clear_focus(), is_visible(), set_visible(), toggle_visibility(), scroll(), scroll_mut(). Move navigation methods from ComponentManager (tab_order, next/prev_component, next/prev_section, next/prev_in_section, first_component, section_index, components_in_section) directly onto UiStateMachine.\n\n## File\nclient-tui/src/ui/fsm/mod.rs\n\n## Acceptance criteria\n- Two new fields on UiStateMachine: focused_component and expanded\n- All ComponentManager methods have equivalents on UiStateMachine\n- Existing code still compiles (ComponentManager not yet removed, just duplicated)","status":"closed","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:36:23Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T14:01:43Z","closed_at":"2026-02-21T14:01:43Z","close_reason":"Added focused_component, expanded, visibility, scroll_state fields to UiStateMachine with all ComponentManager method equivalents. Compiles cleanly alongside existing ComponentManager."}
{"id":"chesstty-1ra","title":"Unify controls derivation and remove per-state controls field","description":"## Problem\n\nEach per-state struct has its own `controls: Vec\u003cControl\u003e` field and a `derive_controls()` method:\n- GameBoardState::derive_controls() (game_board.rs:60-98)\n- ReviewBoardState::derive_controls() (review_board.rs:48-77)\n- GameBoardPaneFocusedState::derive_controls() (game_board_pane_focused.rs:34-45)\n\nAdditionally, the renderer in renderer.rs:170-237 has ANOTHER copy of controls rendering that hardcodes its own control labels for review vs game mode, completely independent of the per-state controls.\n\nThis means controls are defined in at least two places and can get out of sync.\n\n## What needs to happen\n\n1. Create a single function that derives controls from current state:\n   ```rust\n   pub fn derive_controls(mode: \u0026UiMode, focus: \u0026FocusMode, game_mode: \u0026GameMode, game_session: \u0026GameSession) -\u003e Vec\u003cControl\u003e\n   ```\n\n2. Remove `controls` field and `derive_controls()` from all per-state structs\n\n3. Update the Controls component in renderer.rs to use the shared derive_controls() function instead of hardcoding labels\n\n4. Remove the UiState::controls() method from mod.rs:75-84\n\n## Files to modify\n- client-tui/src/ui/fsm/states/game_board.rs (remove controls field + derive_controls)\n- client-tui/src/ui/fsm/states/review_board.rs (remove controls field + derive_controls)\n- client-tui/src/ui/fsm/states/game_board_pane_focused.rs (remove controls field + derive_controls)\n- client-tui/src/ui/fsm/states/review_board_pane_focused.rs (remove controls)\n- client-tui/src/ui/fsm/renderer.rs (use shared controls derivation)\n- client-tui/src/ui/fsm/mod.rs (remove UiState::controls())\n\n## Acceptance criteria\n- Controls are derived from a single function\n- No per-state struct stores controls\n- Controls bar at bottom of screen shows correct keys for each mode/context\n- Renderer Component::Controls reads from the shared function","status":"open","priority":3,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:28:55Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:28:55Z","dependencies":[{"issue_id":"chesstty-1ra","depends_on_id":"chesstty-hdf","type":"blocks","created_at":"2026-02-21T13:29:17Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-5zb","title":"Extract shared input handlers to eliminate 3x code duplication","description":"## Problem\n\nInput handling in input.rs has massive code duplication across three context handlers:\n\n### Review navigation (n/p/Space/Home/End) — duplicated 3 times:\n- handle_board_context() lines 96-181 (review mode branch)\n- handle_component_selected_context() lines 519-556\n- handle_component_expanded_context() lines 651-688\n\n### Tab navigation logic — duplicated 2 times:\n- handle_board_context() lines 145-174 (review mode Tab)\n- handle_board_context() lines 191-219 (game mode Tab)\n\n### Scroll logic with magic number 5 — appears 6 times:\n- handle_component_selected_context() lines 588, 593, 597, 601\n- handle_component_expanded_context() lines 692, 697\n- game_board_pane_focused FSM state mod.rs lines 226-249\n- review_board_pane_focused FSM state mod.rs lines 271-297\n\n## What needs to happen\n\n1. Extract a shared function for review navigation:\n   ```rust\n   fn handle_review_navigation(review: \u0026mut ReviewState, key: KeyCode) -\u003e bool\n   ```\n   Returns true if the key was consumed. Call from all three contexts.\n\n2. Extract a shared function for tab/pane navigation:\n   ```rust\n   fn handle_tab_navigation(fsm: \u0026mut UiStateMachine, state: \u0026GameSession, key: KeyEvent) -\u003e bool\n   ```\n\n3. Extract scroll handling with a named constant:\n   ```rust\n   const SCROLL_INCREMENT: u16 = 5;\n   fn handle_scroll(component_manager: \u0026mut ComponentManager, component: \u0026Component, key: KeyCode) -\u003e bool\n   ```\n\n4. Replace all duplicated blocks with calls to the shared functions\n\n5. Remove the scroll handling from the FSM #[state] methods (game_board_pane_focused, review_board_pane_focused) since input.rs already handles it\n\n## Files to modify\n- client-tui/src/ui/input.rs (extract shared functions, replace duplicated blocks)\n- client-tui/src/ui/fsm/mod.rs (remove duplicated scroll from #[state] methods)\n\n## Acceptance criteria\n- Review navigation code exists in exactly ONE place\n- Tab navigation code exists in exactly ONE place\n- Scroll logic uses a named constant and exists in exactly ONE place\n- No behavioral changes — all key bindings work identically","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:27:50Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:27:50Z","dependencies":[{"issue_id":"chesstty-5zb","depends_on_id":"chesstty-7hu","type":"blocks","created_at":"2026-02-21T13:29:15Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-7hu","title":"Flatten UI state: remove duplicated fields from per-state structs","description":"## Problem\n\nUiStateMachine has UI state fields at the top level (tab_input, input_phase, component_manager, popup_menu, snapshot_dialog, review_tab, review_moves_selection, selected_promotion_piece) in mod.rs:124-135. But the per-state structs ALSO have their own copies of many of these fields:\n\n- GameBoardState (states/game_board.rs:10-21): has tab_input, input_phase, input_buffer, popup_menu, snapshot_dialog, paused\n- ReviewBoardState (states/review_board.rs:7-15): has review_tab, review_moves_selection, input_buffer, review_ui\n\nThe per-state copies are DEAD WEIGHT — input.rs reads/writes from UiStateMachine's top-level fields, not the state struct fields. This causes confusion about which is authoritative.\n\n## What needs to happen\n\n1. Audit each field in GameBoardState, ReviewBoardState, GameBoardPaneFocusedState, ReviewBoardPaneFocusedState to determine if it's actually read anywhere\n2. Remove fields that duplicate UiStateMachine top-level fields (tab_input, input_phase, popup_menu, snapshot_dialog, etc.)\n3. Keep only fields that are genuinely state-specific (e.g. render_spec, controls, focused_component)\n4. Update any code that reads from per-state fields to read from UiStateMachine instead\n5. Verify the stored RenderSpec in each state struct — most layout() methods compute layout dynamically already, so the stored render_spec may be removable too\n\n## Files to modify\n- client-tui/src/ui/fsm/states/game_board.rs (remove duplicated fields)\n- client-tui/src/ui/fsm/states/review_board.rs (remove duplicated fields)\n- client-tui/src/ui/fsm/states/game_board_pane_focused.rs (check for duplication)\n- client-tui/src/ui/fsm/states/review_board_pane_focused.rs (check for duplication)\n- client-tui/src/ui/fsm/mod.rs (ensure top-level fields are the single authority)\n\n## Acceptance criteria\n- No field exists in both a per-state struct AND UiStateMachine\n- All input.rs and render_loop.rs code reads from a single authoritative location\n- All existing functionality still works (pane selection, scrolling, input, review mode)","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:27:39Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:27:39Z","dependencies":[{"issue_id":"chesstty-7hu","depends_on_id":"chesstty-bor","type":"blocks","created_at":"2026-02-21T13:36:56Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"},{"issue_id":"chesstty-7hu","depends_on_id":"chesstty-ncp","type":"blocks","created_at":"2026-02-21T13:36:56Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-9t6","title":"Migrate renderer.rs to flat focus model","description":"## What\nReplace all fsm.component_manager.X() calls in renderer.rs with fsm.X(). This is primarily selected_component() and scroll() calls at approximately lines 243, 245, 257, 259, 269, 271, 277, 279, 293, 295, 307, 309.\n\n## Files\n- client-tui/src/ui/fsm/renderer.rs\n\n## Acceptance criteria\n- No references to component_manager in renderer.rs\n- Rendering still works correctly for selected/expanded panes","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:36:32Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:36:32Z","dependencies":[{"issue_id":"chesstty-9t6","depends_on_id":"chesstty-0wi","type":"blocks","created_at":"2026-02-21T13:36:51Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-bor","title":"Remove dead per-state struct fields from GameBoard and ReviewBoard","description":"## What\nRemove fields from GameBoardState that duplicate UiStateMachine: tab_input (line 11), input_phase (line 12), input_buffer (line 13), game_mode (line 14), move_count (line 15), popup_menu (line 18), snapshot_dialog (line 19), paused (line 20). Keep only: render_spec, controls.\n\nRemove fields from ReviewBoardState that duplicate UiStateMachine: review_tab (line 8), review_moves_selection (line 9), input_buffer (line 10), review_ui (line 11), total_plies (line 12). Keep only: render_spec, controls.\n\nUpdate any remaining code that reads from per-state fields to read from UiStateMachine or GameSession instead.\n\n## Files\n- client-tui/src/ui/fsm/states/game_board.rs\n- client-tui/src/ui/fsm/states/review_board.rs\n- Any constructors/callers that populate these fields\n\n## Acceptance criteria\n- GameBoardState has only render_spec and controls\n- ReviewBoardState has only render_spec and controls\n- No field exists in both a per-state struct and UiStateMachine\n- All functionality still works","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:36:40Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:36:40Z","dependencies":[{"issue_id":"chesstty-bor","depends_on_id":"chesstty-9t6","type":"blocks","created_at":"2026-02-21T13:36:54Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"},{"issue_id":"chesstty-bor","depends_on_id":"chesstty-m2n","type":"blocks","created_at":"2026-02-21T13:36:54Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"},{"issue_id":"chesstty-bor","depends_on_id":"chesstty-soj","type":"blocks","created_at":"2026-02-21T13:36:54Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-h58","title":"Replace statig FSM with simple UiMode enum","description":"## Problem\n\nThe statig FSM framework adds complexity without proportional value. Evidence:\n\n1. Most #[state] methods are empty pass-throughs:\n   - game_board() (mod.rs:195-203): returns Outcome::Handled for all keys\n   - review_board() (mod.rs:207-215): returns Outcome::Handled for all keys\n\n2. The code bypasses statig with unsafe:\n   - render_loop.rs:490: `unsafe { fsm.inner_mut() }` to get mutable access\n   \n3. Input.rs directly mutates current_state instead of using transitions:\n   - input.rs:622-624: `fsm.current_state = UiState::review_board_pane_focused(component)`\n   - input.rs:629-636: `fsm.current_state = UiState::review_board()`\n\n4. PaneFocused variants are redundant — FocusMode in ComponentManager already tracks this:\n   - GameBoardPaneFocused exists only to intercept scroll keys (handled by input.rs)\n   - ReviewBoardPaneFocused is identical to GameBoardPaneFocused\n\n## What needs to happen\n\n1. Define a simple UiMode enum replacing UiState:\n   ```rust\n   #[derive(Clone, Debug, PartialEq)]\n   pub enum UiMode {\n       StartScreen,\n       GameBoard,\n       ReviewBoard,\n       MatchSummary,\n   }\n   ```\n   No PaneFocused variants — pane focus is tracked by ComponentManager.focus_mode.\n\n2. Replace UiStateMachine's statig integration:\n   - Remove `#[state_machine]` attribute and all `#[state]` methods from mod.rs:154-330\n   - Replace `current_state: UiState` with `mode: UiMode`\n   - Move transition logic (StartScreen -\u003e GameBoard, etc.) into simple methods on UiStateMachine\n   - Remove the statig dependency from Cargo.toml\n\n3. Update render_loop.rs:\n   - Remove `use statig::blocking::IntoStateMachineExt`\n   - Replace `let mut fsm = UiStateMachine::default().state_machine()` with `let mut fsm = UiStateMachine::default()`\n   - Remove `fsm.handle(\u0026UiEvent::Key(key))` call (line 488) — input.rs handles everything\n   - Remove `unsafe { fsm.inner_mut() }` — direct access to fsm\n   - Keep `fsm.handle(\u0026UiEvent::TimerTick)` or replace with direct method\n\n4. Update input.rs:\n   - Replace `fsm.current_state = UiState::game_board()` with `fsm.mode = UiMode::GameBoard`\n   - Remove PaneFocused state transitions — just use ComponentManager.expand_component() / clear_focus()\n\n5. Update layout derivation:\n   - Match on UiMode + ComponentManager.focus_mode instead of UiState variants\n   - The layout() methods on per-state structs move to UiStateMachine or a layout module\n\n6. Remove per-state struct files that become unnecessary:\n   - states/game_board_pane_focused.rs (replaced by FocusMode::ComponentExpanded)\n   - states/review_board_pane_focused.rs (replaced by FocusMode::ComponentExpanded)\n\n## Files to modify\n- client-tui/src/ui/fsm/mod.rs (major: replace statig with UiMode enum)\n- client-tui/src/ui/fsm/states/ (remove PaneFocused structs, simplify others)\n- client-tui/src/ui/render_loop.rs (remove statig usage, simplify fsm access)\n- client-tui/src/ui/input.rs (update state transitions)\n- client-tui/src/ui/fsm/renderer.rs (update if any match on UiState)\n- client-tui/Cargo.toml (remove statig dependency)\n\n## Acceptance criteria\n- statig crate is no longer a dependency\n- No unsafe code for FSM access\n- UiMode has 4 variants (no PaneFocused)\n- Pane focus is tracked solely by ComponentManager.focus_mode\n- All screen transitions still work (menu -\u003e game, game -\u003e review, etc.)\n- All pane selection/expansion still works","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:28:07Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:28:07Z","dependencies":[{"issue_id":"chesstty-h58","depends_on_id":"chesstty-5zb","type":"blocks","created_at":"2026-02-21T13:29:16Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"},{"issue_id":"chesstty-h58","depends_on_id":"chesstty-7hu","type":"blocks","created_at":"2026-02-21T13:29:16Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-hdf","title":"Compute layout purely from state (remove stored RenderSpec)","description":"## Problem\n\nEach per-state struct (GameBoardState, ReviewBoardState, etc.) stores a `render_spec: RenderSpec` field that is set at construction time. However, the dynamic `layout()` methods on these structs ALREADY compute layout from current state, making the stored RenderSpec partially dead code.\n\nFor example:\n- GameBoardState::layout() (game_board.rs:102-155) builds layout dynamically from shared.tab_input.active and shared.component_manager.is_visible()\n- ReviewBoardState::layout() (review_board.rs:86-121) builds layout dynamically\n- But StartScreenState and MatchSummaryState use render_spec.layout.clone() directly (mod.rs:66,71)\n\nThe stored RenderSpec creates confusion about whether the static or dynamic layout is used.\n\n## What needs to happen\n\n1. Move all layout computation to a single module/function:\n   ```rust\n   pub fn compute_layout(mode: \u0026UiMode, fsm: \u0026UiStateMachine) -\u003e Layout\n   ```\n   This function matches on UiMode and FocusMode to produce the correct layout.\n\n2. Remove the `render_spec` field from all per-state structs:\n   - GameBoardState: remove render_spec field\n   - ReviewBoardState: remove render_spec field\n   - GameBoardPaneFocusedState: remove render_spec field (or remove struct entirely per issue chesstty-h58)\n   - ReviewBoardPaneFocusedState: remove render_spec field (or remove struct entirely)\n   - StartScreenState: move its simple layout into compute_layout()\n   - MatchSummaryState: move its simple layout into compute_layout()\n\n3. Remove the `expanded_panel` field from RenderSpec — pane expansion is tracked by ComponentManager.focus_mode.\n\n4. Update UiStateMachine::layout() to call compute_layout() instead of delegating to per-state structs.\n\n5. Consider whether RenderSpec itself is still needed or if Layout alone suffices.\n\n## Files to modify\n- client-tui/src/ui/fsm/render_spec.rs (simplify RenderSpec or replace with Layout)\n- client-tui/src/ui/fsm/states/game_board.rs (remove render_spec, keep layout logic)\n- client-tui/src/ui/fsm/states/review_board.rs (remove render_spec, keep layout logic)\n- client-tui/src/ui/fsm/states/start_screen.rs (move layout to central function)\n- client-tui/src/ui/fsm/states/match_summary.rs (move layout to central function)\n- client-tui/src/ui/fsm/mod.rs (update layout() delegation)\n\n## Acceptance criteria\n- No per-state struct stores a RenderSpec\n- Layout is computed fresh from UiMode + ComponentManager state each frame\n- Layout for all modes (start screen, game board, review board, match summary) renders correctly\n- Pane expansion layout derives from ComponentManager.focus_mode, not from a separate UiState variant","status":"open","priority":3,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:28:47Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:28:47Z","dependencies":[{"issue_id":"chesstty-hdf","depends_on_id":"chesstty-h58","type":"blocks","created_at":"2026-02-21T13:29:17Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-m2n","title":"Migrate layout derivation to use expanded_component","description":"## What\nUpdate UiStateMachine::layout() to check self.expanded_component() instead of matching on UiState::GameBoardPaneFocused / UiState::ReviewBoardPaneFocused. Add layout_with_expanded(comp) method to GameBoardState and ReviewBoardState that substitutes the expanded component into the board's position in the layout (reusing logic from RenderSpec::game_board_with_pane() / review_board_with_pane()).\n\n## Files\n- client-tui/src/ui/fsm/mod.rs (layout() method)\n- client-tui/src/ui/fsm/states/game_board.rs (add layout_with_expanded)\n- client-tui/src/ui/fsm/states/review_board.rs (add layout_with_expanded)\n\n## Acceptance criteria\n- layout() no longer matches on PaneFocused variants\n- Expanded pane layout works correctly via expanded_component()\n- layout_with_expanded() methods exist on both state structs","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:36:36Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:36:36Z","dependencies":[{"issue_id":"chesstty-m2n","depends_on_id":"chesstty-0wi","type":"blocks","created_at":"2026-02-21T13:36:52Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-ncp","title":"Remove PaneFocused variants, delete ComponentManager, clean up imports","description":"## What\nFinal cleanup after migration is complete:\n\n1. Remove UiState enum variants: GameBoardPaneFocused and ReviewBoardPaneFocused\n2. Remove the #[state] methods: game_board_pane_focused() and review_board_pane_focused()\n3. Remove match arms for PaneFocused in render_spec(), layout(), controls()\n4. Delete files: states/game_board_pane_focused.rs, states/review_board_pane_focused.rs\n5. Delete file: fsm/component_manager.rs\n6. Update states/mod.rs: remove pub use and mod lines for deleted files\n7. Update prelude.rs: remove ComponentManager, FocusMode from imports\n8. Remove pub mod component_manager and pub use from fsm/mod.rs\n\n## Files to delete\n- client-tui/src/ui/fsm/component_manager.rs\n- client-tui/src/ui/fsm/states/game_board_pane_focused.rs\n- client-tui/src/ui/fsm/states/review_board_pane_focused.rs\n\n## Files to modify\n- client-tui/src/ui/fsm/mod.rs (remove variants, methods, match arms, module decl)\n- client-tui/src/ui/fsm/states/mod.rs (remove exports)\n- client-tui/src/prelude.rs (remove imports)\n\n## Acceptance criteria\n- No FocusMode or ComponentManager types exist in codebase\n- No PaneFocused state variants exist\n- cargo check -p client-tui passes\n- cargo test -p client-tui passes","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:36:47Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:36:47Z","dependencies":[{"issue_id":"chesstty-ncp","depends_on_id":"chesstty-9t6","type":"blocks","created_at":"2026-02-21T13:36:55Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"},{"issue_id":"chesstty-ncp","depends_on_id":"chesstty-m2n","type":"blocks","created_at":"2026-02-21T13:36:55Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"},{"issue_id":"chesstty-ncp","depends_on_id":"chesstty-soj","type":"blocks","created_at":"2026-02-21T13:36:55Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-od2","title":"Introduce Message enum and single update() function","description":"## Problem\n\nCurrently there is no unified message/update pattern. Input handling happens through two separate paths:\n\n1. `fsm.handle(\u0026UiEvent::Key(key))` in render_loop.rs:488 — feeds into statig FSM (mostly empty)\n2. `input::handle_key(state, fsm, input_buffer, key)` in render_loop.rs:490 — the real handler\n\nInside input.rs, key events are dispatched through a waterfall of if/match chains that directly mutate both `GameSession` and `UiStateMachine`. There's no intermediate layer that maps raw key events to semantic intent. This makes it hard to:\n- Test input handling (need full GameSession + UiStateMachine)\n- Reuse logic (same intent from different keys requires duplication)\n- Reason about state changes (mutations scattered across match arms)\n\n## What needs to happen\n\n1. Define a Message enum that represents user intent:\n   ```rust\n   pub enum Message {\n       // Board interaction\n       SelectSquare(Square),\n       MovePiece { from: Square, to: Square },\n       PromotePiece(Piece),\n       ClearSelection,\n       \n       // Navigation\n       NextPly,\n       PrevPly,\n       NextCriticalMoment,\n       PrevCriticalMoment,\n       GoToStart,\n       GoToEnd,\n       ToggleAutoPlay,\n       \n       // Pane management\n       SelectNextPane,\n       SelectPrevPane,\n       SelectNextSection,\n       SelectPrevSection,\n       SelectNextInSection,\n       SelectPrevInSection,\n       ExpandPane,\n       CollapsePaneToBoard,\n       \n       // Scrolling\n       ScrollUp,\n       ScrollDown,\n       ScrollToTop,\n       ScrollToBottom,\n       \n       // Tab input\n       ActivateTabInput,\n       TabInputChar(char),\n       TabInputConfirm,\n       TabInputCancel,\n       \n       // Toggles\n       TogglePanel(Component),\n       TogglePause,\n       \n       // Menus/dialogs\n       OpenMenu,\n       CloseMenu,\n       MenuSelect,\n       MenuUp,\n       MenuDown,\n       OpenSnapshotDialog,\n       \n       // App lifecycle\n       Quit,\n       ReturnToMenu,\n       SuspendSession,\n       Undo,\n   }\n   ```\n\n2. Create a key-to-message mapping function:\n   ```rust\n   fn map_key_to_message(\n       key: KeyEvent,\n       mode: \u0026UiMode,\n       focus: \u0026FocusMode,\n       game_mode: \u0026GameMode,\n       tab_input_active: bool,\n       popup_active: bool,\n   ) -\u003e Option\u003cMessage\u003e\n   ```\n   This is a PURE function — no mutation, just maps context + key -\u003e intent.\n\n3. Create a single update function:\n   ```rust\n   async fn update(\n       state: \u0026mut GameSession,\n       fsm: \u0026mut UiStateMachine,\n       msg: Message,\n   ) -\u003e AppAction\n   ```\n   All state mutations go through this function. No direct mutation of fsm/state from key handlers.\n\n4. Update render_loop.rs to use the new pattern:\n   ```rust\n   if let Some(Event::Key(key)) = term_event {\n       if let Some(msg) = map_key_to_message(key, \u0026fsm.mode, ...) {\n           match update(\u0026mut state, \u0026mut fsm, msg).await {\n               AppAction::Continue =\u003e {}\n               AppAction::Quit =\u003e return Ok(ExitReason::Quit),\n               // ...\n           }\n       }\n   }\n   ```\n\n5. Migrate input.rs handlers into the update() function, organized by message variant rather than by context/focus mode.\n\n## Files to modify\n- client-tui/src/ui/message.rs (NEW: Message enum + key mapping)\n- client-tui/src/ui/update.rs (NEW: single update function)\n- client-tui/src/ui/input.rs (refactor into update.rs, then remove or reduce to key mapping)\n- client-tui/src/ui/render_loop.rs (use new map -\u003e update pattern)\n- client-tui/src/ui/mod.rs (add new modules)\n\n## Acceptance criteria\n- All key events go through map_key_to_message() -\u003e update() pipeline\n- No direct fsm/state mutation outside of update()\n- map_key_to_message() is a pure function (testable without GameSession)\n- update() is the single state mutation entry point\n- All existing key bindings produce identical behavior\n- The unsafe { fsm.inner_mut() } is gone","status":"open","priority":2,"issue_type":"feature","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:28:33Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:28:33Z","dependencies":[{"issue_id":"chesstty-od2","depends_on_id":"chesstty-h58","type":"blocks","created_at":"2026-02-21T13:29:16Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
{"id":"chesstty-soj","title":"Migrate input.rs to flat focus model","description":"## What\nReplace the FocusMode match dispatch in input.rs (line 79-83) with a match on (fsm.focused_component, fsm.expanded). Replace all fsm.component_manager.X() calls with fsm.X() throughout input.rs. Simplify pane expand (line 619-627) to just call fsm.expand_component() without mutating current_state. Simplify pane collapse (lines 629-637, 705-712) to just call fsm.clear_focus() without mutating current_state. Remove FocusMode import.\n\n## Files\n- client-tui/src/ui/input.rs\n\n## Key changes\n- Main dispatch: FocusMode match → (focused_component, expanded) match\n- ~20 component_manager.X() calls → fsm.X()\n- Expand: remove UiState::game_board_pane_focused/review_board_pane_focused transitions\n- Collapse: remove UiState::game_board/review_board transitions\n\n## Acceptance criteria\n- No references to component_manager in input.rs\n- No references to FocusMode in input.rs\n- No UiState mutations for focus changes in input.rs\n- All input handling still works (tab cycling, expand, collapse, scroll)","status":"open","priority":2,"issue_type":"task","owner":"benedikt.schnatterbeck@fresha.com","created_at":"2026-02-21T13:36:29Z","created_by":"Benedikt Schnatterbeck","updated_at":"2026-02-21T13:36:29Z","dependencies":[{"issue_id":"chesstty-soj","depends_on_id":"chesstty-0wi","type":"blocks","created_at":"2026-02-21T13:36:51Z","created_by":"Benedikt Schnatterbeck","metadata":"{}"}]}
